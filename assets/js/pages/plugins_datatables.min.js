$(function() {
    $(document).on('click', '.selectID', function(event) {
        var selectedID = $(this).closest('tr').attr('id');
        app_datatables.select_row(selectedID);
        $(this).closest('tr').css('background','rgba(0,0,0,.085)');
    	event.preventDefault();
    });
    if($('#table_attr').length){
        app_datatables.table_attr();
        $(document).on('click', '#table_attr tbody tr', function(event) {
            var attrID = $(this).attr('id');
            app_datatables.select_row(attrID);
            $(this).css('background','rgba(0,0,0,.085)');
            event.preventDefault();
        });
    }
    if($('#table_province').length){
        app_datatables.table_province();
        $(document).on('click', '#table_province tbody tr', function(event) {
            var provinceID = $(this).attr('id');
            app_datatables.select_row(provinceID);
            $(this).css('background','rgba(0,0,0,.085)');
            event.preventDefault();
        });
    }
    if($('#table_place').length){
        app_datatables.table_place();
    }
    if($('#logTableID').length){
        app_datatables.table_log($('#logTableID').val());
        $('#logTableID').change(function(){
            app_datatables.table_log($(this).val());
        })
    }
    if($('#importTable').length){
        $('#import_form').validate({
            rules: {
                filexls: {
                    required: true,
                    extension: "xls|csv"
                }
            },
            messages: {
                filexls: {
                    extension: Lang.get('strings.valid_import_ext')
                },
            },
            errorPlacement: function(error, element) {
                error.insertAfter(element.parent().parent());
            }
        });
        $('#download_sample').attr('href', 'sample/'+$('#importTable').val());
        $('#importTable').change(function(){
            $('#download_sample').attr('href', 'sample/'+$(this).val());
        })
        $('input[type=file]').change(function (event) {
            var filename = $(this).val().split('\\').pop();
            $(this).parent().siblings('label.filename').text(filename);
        });
    }
}), app_datatables = {
    select_row: function(ID){
        $('.sub').attr('data-id',ID);
        $("#_selectedID").val(ID);
        var url = $("#export").attr('href');
        if(isNaN(url.substring(url.lastIndexOf('/') + 1))){
            $("#export").attr('href',url+"/"+ID);
        }else{
            $("#export").attr('href',url.slice(0, url.lastIndexOf('/'))+"/"+ID);
        }
        if($("#table_subattr").length){
            app_datatables.table_subattr(ID);
            $('#table_attr tbody tr').css('background','#fff');
        }
        if($("#table_municipality").length){
            app_datatables.table_municipality(ID);
            $('#table_province tbody tr').css('background','#fff');
        }
    },
    table_attr: function() {
    	var t = $("#table_attr");
    	if(t.length) {
			var opt = {};
			opt.dom = 
            "<'dt-uikit-header'<'uk-grid'<'uk-width-medium-2-3'l><'uk-width-medium-1-3'f>>>" +
            "<'uk-overflow-container'r>" +
            "<'uk-overflow-container't>" +
            "<'dt-uikit-footer'<'uk-grid'<'uk-width-medium-3-10'i><'uk-width-medium-7-10'p>>>",
			opt.processing = true,
			opt.serverSide = true,
            opt.lengthMenu = [5, 10, 25, 50, 100],
			opt.ajax = {
				url: 'attributes/getall',
                type: "POST",
				datatype : "application/json",
				headers: {
			        'X-CSRF-TOKEN': _token
			    },
				error: function() {}
			},
            opt.order = [[ 1, "asc" ]],
			opt.columns = [
                {"data": '0',"width": "5%"},
				{"data": '1',"width": "84%"},
				{"data": '2',"width": "5%","orderable": false},
			],
            opt.initComplete = function(settings,json) {
                if(!$('#table_attr tbody tr:first td:first').hasClass('dataTables_empty')){
                    var dtid = $("#table_attr tbody tr:first").attr('id');
                    app_datatables.select_row(dtid);
                    $("#table_attr tbody tr:first").css('background','rgba(0,0,0,.085)');
                }
                var api = new $.fn.dataTable.Api(settings);
                $('td:eq(0)', api.rows().nodes()).attr('data-header', api.columns(0).header()[0].innerText);
                $('td:eq(1)', api.rows().nodes()).attr('data-header', api.columns(1).header()[0].innerText);
                $('td:eq(2)', api.rows().nodes()).attr('data-header', api.columns(2).header()[0].innerText);
            },
            opt.drawCallback = function( settings ) {
                $('#table_attr tbody tr').css('background','#fff');
                $("#table_attr tbody tr[id='"+$("#_selectedID").val()+"']").css('background','rgba(0,0,0,.085)');
            }
	        t.dataTable().fnDestroy();
	        var oTable = t.dataTable(opt);
	        oTable.fnDraw();
    	}
    },
    table_subattr: function(aid) {
    	var t = $("#table_subattr");
    	if(t.length) {
			var opt = {};
			opt.dom = 
            "<'dt-uikit-header'<'uk-grid'<'uk-width-medium-1-3'l><'uk-width-medium-1-3'f><'uk-width-medium-1-3'B>>>" +
            "<'uk-overflow-container'r>" +
            "<'uk-overflow-container't>" +
            "<'dt-uikit-footer'<'uk-grid'<'uk-width-medium-3-10'i><'uk-width-medium-7-10'p>>>",
            opt.buttons = [
                {
                    text: '<i class="uk-icon-plus-square"></i> ' + Lang.get('strings.add_new'),
                    className: "md-btn md-btn-primary md-btn-wave-light waves-effect waves-button waves-light sub",
                    action: function ( e, dt, node, config ) {
                        showAjaxModal('subattributes/create',Lang.get('strings.sattr_add'),node);
                    }
                }
            ]
			opt.processing = true,
			opt.serverSide = true,
            opt.lengthMenu = [5, 10, 25, 50, 100],
			opt.ajax = {
				url: 'attributes/getallsubattr',
                data: {attr:aid},
                type: "POST",
				datatype : "application/json",
				headers: {
			        'X-CSRF-TOKEN': _token
			    },
				error: function() {}
			},
            opt.order = [[ 1, "asc" ]],
			opt.columns = [
                {"data": '0',"width": "5%"},
				{"data": '1',"width": "45%"},
                {"data": '2',"width": "20%"},
				{"data": '3',"width": "20%"},
				{"data": '4',"width": "10%","orderable": false},
			],
            opt.initComplete = function(settings,json) {
                var api = new $.fn.dataTable.Api(settings);
                $('td:eq(0)', api.rows().nodes()).attr('data-header', api.columns(0).header()[0].innerText);
                $('td:eq(1)', api.rows().nodes()).attr('data-header', api.columns(1).header()[0].innerText);
                $('td:eq(2)', api.rows().nodes()).attr('data-header', api.columns(2).header()[0].innerText);
                $('td:eq(3)', api.rows().nodes()).attr('data-header', api.columns(3).header()[0].innerText);
                $('td:eq(4)', api.rows().nodes()).attr('data-header', api.columns(4).header()[0].innerText);
            },
	        t.dataTable().fnDestroy();
	        var oTable = t.dataTable(opt);
            t.on('init.dt', function() {
                $('.sub').attr('data-id',aid);
            });
            oTable.fnDraw();
    	}
    },
    table_province: function() {
        var t = $("#table_province");
        if(t.length) {
            var opt = {};
            opt.dom = 
            "<'dt-uikit-header'<'uk-grid'<'uk-width-medium-2-3'l><'uk-width-medium-1-3'f>>>" +
            "<'uk-overflow-container'r>" +
            "<'uk-overflow-container't>" +
            "<'dt-uikit-footer'<'uk-grid'<'uk-width-medium-3-10'i><'uk-width-medium-7-10'p>>>",
            opt.processing = true,
            opt.serverSide = true,
            opt.lengthMenu = [5, 10, 25, 50, 100],
            opt.ajax = {
                url: 'geography/getall',
                type: "POST",
                datatype : "application/json",
                headers: {
                    'X-CSRF-TOKEN': _token
                },
                error: function() {}
            },
            opt.order = [[ 1, "asc" ]],
            opt.columns = [
                {"data": '0',"width": "5%"},
                {"data": '1',"width": "80%"},
                {"data": '2',"width": "5%"},
                {"data": '3',"width": "10%","orderable": false},
            ],
            opt.initComplete = function(settings,json) {
                if(!$('#table_province tbody tr:first td:first').hasClass('dataTables_empty')){
                    var dtid = $("#table_province tbody tr:first").attr('id');
                    app_datatables.select_row(dtid);
                    $("#table_province tbody tr:first").css('background','rgba(0,0,0,.085)');
                }
                var api = new $.fn.dataTable.Api(settings);
                $('td:eq(0)', api.rows().nodes()).attr('data-header', api.columns(0).header()[0].innerText);
                $('td:eq(1)', api.rows().nodes()).attr('data-header', api.columns(1).header()[0].innerText);
                $('td:eq(2)', api.rows().nodes()).attr('data-header', api.columns(2).header()[0].innerText);
                $('td:eq(3)', api.rows().nodes()).attr('data-header', api.columns(3).header()[0].innerText);
            },
            opt.drawCallback = function( settings ) {
                $('#table_province tbody tr').css('background','#fff');
                $("#table_province tbody tr[id='"+$("#_selectedID").val()+"']").css('background','rgba(0,0,0,.085)');
            }
            t.dataTable().fnDestroy();
            var oTable = t.dataTable(opt);
            oTable.fnDraw();
        }
    },
    table_municipality: function(pid) {
        var t = $("#table_municipality");
        if(t.length) {
            var opt = {};
            opt.dom = 
            "<'dt-uikit-header'<'uk-grid'<'uk-width-medium-1-3'l><'uk-width-medium-1-3'f><'uk-width-medium-1-3'B>>>" +
            "<'uk-overflow-container'r>" +
            "<'uk-overflow-container't>" +
            "<'dt-uikit-footer'<'uk-grid'<'uk-width-medium-3-10'i><'uk-width-medium-7-10'p>>>",
            opt.buttons = [
                {
                    text: '<i class="uk-icon-plus-square"></i> ' + Lang.get('strings.add_new'),
                    className: "md-btn md-btn-primary md-btn-wave-light waves-effect waves-button waves-light sub",
                    action: function ( e, dt, node, config ) {
                        showAjaxModal('municipality/create',Lang.get('strings.muncplt_add'),node);
                    }
                }
            ]
            opt.processing = true,
            opt.serverSide = true,
            opt.lengthMenu = [5, 10, 25, 50, 100],
            opt.ajax = {
                url: 'geography/getallmuncipality',
                data: {province:pid},
                type: "POST",
                datatype : "application/json",
                headers: {
                    'X-CSRF-TOKEN': _token
                },
                error: function() {}
            },
            opt.order = [[ 1, "asc" ]],
            opt.columns = [
                {"data": '0',"width": "5%"},
                {"data": '1',"width": "45%"},
                {"data": '2',"width": "20%"},
                {"data": '3',"width": "20%"},
                {"data": '4',"width": "10%","orderable": false},
            ],
            opt.initComplete = function(settings,json) {
                var api = new $.fn.dataTable.Api(settings);
                $('td:eq(0)', api.rows().nodes()).attr('data-header', api.columns(0).header()[0].innerText);
                $('td:eq(1)', api.rows().nodes()).attr('data-header', api.columns(1).header()[0].innerText);
                $('td:eq(2)', api.rows().nodes()).attr('data-header', api.columns(2).header()[0].innerText);
                $('td:eq(3)', api.rows().nodes()).attr('data-header', api.columns(3).header()[0].innerText);
                $('td:eq(4)', api.rows().nodes()).attr('data-header', api.columns(4).header()[0].innerText);
            },
            t.dataTable().fnDestroy();
            var oTable = t.dataTable(opt);
            t.on('init.dt', function() {
                $('.sub').attr('data-id',pid);
            });
            oTable.fnDraw();
        }
    },
    table_place: function(){
        var t = $("#table_place");
        if(t.length) {
            var opt = {};
            opt.dom = 
            "<'dt-uikit-header'<'uk-grid'<'uk-width-medium-2-3'l><'uk-width-medium-1-3'f>>>" +
            "<'uk-overflow-container'r>" +
            "<'uk-overflow-container't>" +
            "<'dt-uikit-footer'<'uk-grid'<'uk-width-medium-3-10'i><'uk-width-medium-7-10'p>>>",
            opt.processing = true,
            opt.serverSide = true,
            opt.pageLength = 10,
            opt.ajax = {
                url: 'place/getall',
                type: "POST",
                datatype : "application/json",
                headers: {
                    'X-CSRF-TOKEN': _token
                },
                error: function() {}
            },
            opt.order = [[ 1, "asc" ]],
            opt.columns = [
                {"data": '0',"width": "8%"},
                {"data": '1',"width": "35%"},
                {"data": '2',"width": "35%"},
                {"data": '3',"width": "8%"},
                {"data": '4',"width": "14%","orderable": false},
            ],
            opt.initComplete = function(settings,json) {
                var api = new $.fn.dataTable.Api(settings);
                $('td:eq(0)', api.rows().nodes()).attr('data-header', api.columns(0).header()[0].innerText);
                $('td:eq(1)', api.rows().nodes()).attr('data-header', api.columns(1).header()[0].innerText);
                $('td:eq(2)', api.rows().nodes()).attr('data-header', api.columns(2).header()[0].innerText);
                $('td:eq(3)', api.rows().nodes()).attr('data-header', api.columns(3).header()[0].innerText);
                $('td:eq(4)', api.rows().nodes()).attr('data-header', api.columns(4).header()[0].innerText);
            },
            t.dataTable().fnDestroy();
            var oTable = t.dataTable(opt);
            oTable.fnDraw();
        }
    },
    table_log: function(tableID){
        var t = $("#table_log");
        if(t.length) {
            var opt = {};
            opt.dom = 
            "<'dt-uikit-header'<'uk-grid'<'uk-width-medium-2-3'l>>>" +
            "<'uk-overflow-container'r>" +
            "<'uk-overflow-container't>" +
            "<'dt-uikit-footer'<'uk-grid'<'uk-width-medium-3-10'i><'uk-width-medium-7-10'p>>>",
            opt.processing = true,
            opt.serverSide = true,
            opt.pageLength = 10,
            opt.ajax = {
                url: 'logs/getall',
                type: "POST",
                data: {tID: tableID},
                datatype : "application/json",
                headers: {
                    'X-CSRF-TOKEN': _token
                },
                error: function() {}
            },
            opt.order = [[ 0, "desc" ]],
            opt.columns = [
                {"data": '0',"width": "8%"},
                {"data": '1',"width": "10%"},
                {"data": '2',"width": "45%"},
                {"data": '3',"width": "22%"},
                {"data": '4',"width": "15%","orderable": false},
            ],
            opt.initComplete = function(settings,json) {
                var api = new $.fn.dataTable.Api(settings);
                $('td:eq(0)', api.rows().nodes()).attr('data-header', api.columns(0).header()[0].innerText);
                $('td:eq(1)', api.rows().nodes()).attr('data-header', api.columns(1).header()[0].innerText);
                $('td:eq(2)', api.rows().nodes()).attr('data-header', api.columns(2).header()[0].innerText);
                $('td:eq(3)', api.rows().nodes()).attr('data-header', api.columns(3).header()[0].innerText);
                $('td:eq(4)', api.rows().nodes()).attr('data-header', api.columns(4).header()[0].innerText);
            },
            t.dataTable().fnDestroy();
            var oTable = t.dataTable(opt);
            oTable.fnDraw();
            $('#lsearch').on('keyup', function() {
                oTable.fnFilter(this.value);
            });
        }
    },
    valid_attr: function() {
        var modal = UIkit.modal("#medium_modal");
        $.validator.addMethod("validateaname", function(value, element, jdata) {
            var x = $.ajax({
                type: "POST",
                url: "attributes/verify",
                async: false,
                dataType: "json",
                data: jdata,
                headers: {
                    'X-CSRF-TOKEN': _token
                },
            }).responseText;
            return (x === 'false') ? false : true;
        }, Lang.get('strings.valid_attr_name'));
        $('#attribute_form').validate({
            rules: {
                aname: {
                    required: true,
                    validateaname: {
                        aname: function(){
                            return $("#aname").val();
                        },
                        _aname: function(){
                            return $("#_aname").val();
                        }
                    }
                }
            },
            errorPlacement: function(error, element) {
                if(element.attr('type') == "radio"){
                    element.parent().parent().append(error);
                }else {
                    error.insertAfter(element.parent());
                }
            },
            submitHandler: function(form){
                var l = Ladda.create($(form).find('button').get(0));
                l.start();
                $.ajax({
                    url:$(form).attr("action"),
                    type:'POST',
                    data:$(form).serialize(),
                    datatype : "application/json",
                    success:function(data){
                        l.stop();
                        modal.hide();
                        if(data.sucess == "true"){
                            notifyWithtEle(data.message,'success');
                        }else{
                            notifyWithtEle(data.message,'danger');
                        }
                        app_datatables.table_attr();
                    }
                });
                return false;
            }
        });
        $.validator.addMethod("validatesname", function(value, element, jdata) {
            var x = $.ajax({
                type: "POST",
                url: "subattributes/verify",
                async: false,
                dataType: "json",
                data: jdata,
                headers: {
                    'X-CSRF-TOKEN': _token
                },
            }).responseText;
            return (x === 'false') ? false : true;
        }, Lang.get('strings.valid_sattr_name'));
        $('#subattribute_form').validate({
            rules: {
                sname: {
                    required: true,
                    validatesname: {
                        _attrid: function(){
                            return $("#_attrid").val();
                        },
                        sname: function(){
                            return $("#sname").val();
                        },
                        _sname: function(){
                            return $("#_sname").val();
                        }
                    }
                }
            },
            errorPlacement: function(error, element) {
                if(element.attr('type') == "radio"){
                    element.parent().parent().append(error);
                }else {
                    error.insertAfter(element.parent());
                }
            },
            submitHandler: function(form){
                var l = Ladda.create($(form).find('button').get(0));
                l.start();
                $.ajax({
                    url:$(form).attr("action"),
                    type:'POST',
                    data:$(form).serialize(),
                    datatype : "application/json",
                    success:function(data){
                        l.stop();
                        modal.hide();
                        if(data.sucess == "true"){
                            notifyWithtEle(data.message,'success');
                        }else{
                            notifyWithtEle(data.message,'danger');
                        }
                        app_datatables.table_subattr($(form).find("#_attrid").val());
                    }
                });
                return false;
            }
        });
        $.validator.addMethod("validatepname", function(value, element, jdata) {
            var x = $.ajax({
                type: "POST",
                url: "geography/verify",
                async: false,
                dataType: "json",
                data: jdata,
                headers: {
                    'X-CSRF-TOKEN': _token
                },
            }).responseText;
            return (x === 'false') ? false : true;
        }, Lang.get('strings.valid_prov_name'));
        $('#province_form').validate({
            rules: {
                pname: {
                    required: true,
                    validatepname: {
                        pname: function(){
                            return $("#pname").val();
                        },
                        _pname: function(){
                            return $("#_pname").val();
                        }
                    }
                }
            },
            errorPlacement: function(error, element) {
                if(element.attr('type') == "radio"){
                    element.parent().parent().append(error);
                }else {
                    error.insertAfter(element.parent());
                }
            },
            submitHandler: function(form){
                var l = Ladda.create($(form).find('button').get(0));
                l.start();
                $.ajax({
                    url:$(form).attr("action"),
                    type:'POST',
                    data:$(form).serialize(),
                    datatype : "application/json",
                    success:function(data){
                        l.stop();
                        modal.hide();
                        if(data.sucess == "true"){
                            notifyWithtEle(data.message,'success');
                        }else{
                            notifyWithtEle(data.message,'danger');
                        }
                        app_datatables.table_province();
                    }
                });
                return false;
            }
        });
        $.validator.addMethod("validatemname", function(value, element, jdata) {
            var x = $.ajax({
                type: "POST",
                url: "municipality/verify",
                async: false,
                dataType: "json",
                data: jdata,
                headers: {
                    'X-CSRF-TOKEN': _token
                },
            }).responseText;
            return (x === 'false') ? false : true;
        }, Lang.get('strings.valid_muncplt_name'));
        $('#municipality_form').validate({
            rules: {
                mname: {
                    required: true,
                    validatemname: {
                        _provid: function(){
                            return $("#_provid").val();
                        },
                        mname: function(){
                            return $("#mname").val();
                        },
                        _mname: function(){
                            return $("#_mname").val();
                        }
                    }
                }
            },
            errorPlacement: function(error, element) {
                if(element.attr('type') == "radio"){
                    element.parent().parent().append(error);
                }else {
                    error.insertAfter(element.parent());
                }
            },
            submitHandler: function(form){
                var l = Ladda.create($(form).find('button').get(0));
                l.start();
                $.ajax({
                    url:$(form).attr("action"),
                    type:'POST',
                    data:$(form).serialize(),
                    datatype : "application/json",
                    success:function(data){
                        l.stop();
                        modal.hide();
                        if(data.sucess == "true"){
                            notifyWithtEle(data.message,'success');
                        }else{
                            notifyWithtEle(data.message,'danger');
                        }
                        app_datatables.table_municipality($(form).find("#_provid").val());
                    }
                });
                return false;
            }
        });
        $.validator.addMethod("validateplname", function(value, element, jdata) {
            var x = $.ajax({
                type: "POST",
                url: "place/verify",
                async: false,
                dataType: "json",
                data: jdata,
                headers: {
                    'X-CSRF-TOKEN': _token
                },
            }).responseText;
            return (x === 'false') ? false : true;
        }, Lang.get('strings.valid_place_name'));
        $('#place_form').validate({
            rules: {
                plname: {
                    required: true,
                    validateplname: {
                        _mid: function(){
                            return $("#_mid").val();
                        },
                        plname: function(){
                            return $("#plname").val();
                        },
                        _plname: function(){
                            return $("#_plname").val();
                        }
                    }
                }
            },
            errorPlacement: function(error, element) {
                if(element.attr('type') == "radio"){
                    element.parent().parent().append(error);
                }else {
                    error.insertAfter(element.parent());
                }
            },
            submitHandler: function(form){
                var l = Ladda.create($(form).find('button').get(0));
                l.start();
                $.ajax({
                    url:$(form).attr("action"),
                    type:'POST',
                    data:$(form).serialize()+"&_mid="+$(form).find('#mid').attr('data-id'),
                    datatype : "application/json",
                    success:function(data){
                        l.stop();
                        modal.hide();
                        if(data.sucess == "true"){
                            notifyWithtEle(data.message,'success');
                        }else{
                            notifyWithtEle(data.message,'danger');
                        }
                        app_datatables.table_place();
                    }
                });
                return false;
            }
        });
    }
};